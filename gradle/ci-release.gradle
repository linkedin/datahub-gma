// CI done via ./github/workflows/gh-release.yml.

// Task to fail fast and clearly if required properties are not set.
task verifyBintrayProperties {
  doFirst {
    if (!project.hasProperty('bintray.dryRun')) {
      if (System.getenv('BINTRAY_USER') == null) {
        throw new Exception("Environment variable BINTRAY_USER not set.");
      }
      if (System.getenv('BINTRAY_KEY') == null) {
        throw new Exception("Environment variable BINTRAY_USER not set.");
      }
    }
  }
}

task bintrayUploadAll {
  description = "Runs 'bintrayUpload' tasks from all projects"
  mustRunAfter "githubRelease" // github release is easier to rollback so we run it first
}

allprojects {
  tasks.matching { it.name == "bintrayUpload" }.all {
    it.dependsOn verifyBintrayProperties
    bintrayUploadAll.dependsOn it
  }
}

task artifactoryPublishAll {
  description = "Runs 'artifactoryPublish' tasks from all projects"
  mustRunAfter "githubRelease" // github release is easier to rollback so we run it first
}

allprojects {
  tasks.matching { it.name == "artifactoryPublish" }.all {
    artifactoryPublishAll.dependsOn it
  }
}

task ciPerformRelease {
  description = "Performs the release, intended to be ran on CI"
  dependsOn "githubRelease", "bintrayUploadAll", "artifactoryPublishAll"
}

task getVersion() {
  doFirst {
    println version
  }
}
